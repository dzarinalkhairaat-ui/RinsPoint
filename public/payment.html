<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pembayaran - RinsPoint</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        .payment-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }
        .row-detail {
            display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem;
        }
        .label { color: #94a3b8; }
        .value { color: white; font-weight: 500; text-align: right; }
        .total-row {
            margin-top: 15px; padding-top: 15px; border-top: 1px dashed #334155;
            display: flex; justify-content: space-between; align-items: center;
        }
        .total-label { color: white; font-weight: 700; font-size: 1rem; }
        .total-value { color: #4ade80; font-weight: 700; font-size: 1.3rem; }

        .payment-method {
            display: flex; align-items: center; gap: 15px;
            background: #0f172a; padding: 15px; border-radius: 12px;
            border: 1px solid #334155; margin-bottom: 10px; cursor: pointer;
        }
        .payment-method.active { border-color: #4ade80; background: rgba(74, 222, 128, 0.05); }
        .method-icon { font-size: 1.5rem; color: #4ade80; width: 30px; text-align: center; }

        .btn-confirm {
            background: #25D366; /* Warna WA */
            color: white; border: none; width: 100%; padding: 15px;
            border-radius: 12px; font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-top: 20px; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
        }
        .btn-confirm:active { transform: scale(0.98); }

        /* PERINGATAN NOMOR */
        .warning-box {
            background: rgba(245, 158, 11, 0.1); 
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px; padding: 10px; margin-bottom: 15px;
            display: flex; gap: 10px; align-items: start;
        }
        .warning-text { color: #f59e0b; font-size: 0.8rem; line-height: 1.4; }

        /* MODAL PILIH ADMIN */
        .admin-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .admin-modal.show { display: flex; }
        .admin-box {
            background: #1e293b; width: 100%; max-width: 350px;
            border-radius: 20px; padding: 20px; border: 1px solid #334155;
        }
        .admin-list { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .admin-item {
            background: #0f172a; padding: 12px; border-radius: 10px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            border: 1px solid #334155; transition: 0.2s;
        }
        .admin-item:active { transform: scale(0.98); background: #334155; }
        .admin-avatar {
            width: 40px; height: 40px; background: #25D366; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white;
        }
    </style>
</head>
<body>

    <div class="mobile-container">
        
        <header class="main-header">
            <a href="/ppob.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
            <div class="logo-text">Rincian Pembayaran</div>
        </header>

        <main style="padding: 20px;">
            
            <h3 style="color: white; margin-bottom: 10px;">Ringkasan Pesanan</h3>
            
            <div class="warning-box">
                <i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b; margin-top: 2px;"></i>
                <div class="warning-text">
                    Mohon cek kembali Nomor Tujuan / ID Game Anda. Kesalahan nomor bukan tanggung jawab kami.
                </div>
            </div>
            
            <div class="payment-card">
                <div class="row-detail">
                    <span class="label">Produk</span>
                    <span class="value" id="dispProduct">-</span>
                </div>
                <div class="row-detail">
                    <span class="label">Nomor Tujuan</span>
                    <span class="value" id="dispNumber">-</span>
                </div>
                <div class="row-detail">
                    <span class="label">Kategori</span>
                    <span class="value" id="dispCategory">-</span>
                </div>
                
                <div class="total-row">
                    <span class="total-label">Total Bayar</span>
                    <span class="total-value" id="dispPrice">Rp 0</span>
                </div>
            </div>

            <h3 style="color: white; margin-bottom: 15px;">Metode Pembayaran</h3>
            
            <div class="payment-method active">
                <div class="method-icon"><i class="fa-brands fa-whatsapp"></i></div>
                <div style="flex: 1;">
                    <div style="color: white; font-weight: 600; font-size: 0.95rem;">Bayar via Admin (Manual)</div>
                    <div style="color: #94a3b8; font-size: 0.8rem;">Transfer Bank / E-Wallet / QRIS</div>
                </div>
                <i class="fa-solid fa-circle-check" style="color: #4ade80;"></i>
            </div>

            <button onclick="openAdminModal()" class="btn-confirm">
                <i class="fa-brands fa-whatsapp" style="font-size: 1.2rem;"></i>
                Konfirmasi Pesanan
            </button>

            <p style="color: #64748b; font-size: 0.8rem; text-align: center; margin-top: 15px; line-height: 1.5;">
                Klik tombol di atas untuk memilih Admin dan menyelesaikan pembayaran.
            </p>

        </main>
    </div>

    <div id="adminModal" class="admin-modal">
        <div class="admin-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: white; margin: 0;">Pilih Admin</h3>
                <i class="fa-solid fa-xmark" style="color: #ef4444; font-size: 1.5rem; cursor: pointer;" onclick="closeAdminModal()"></i>
            </div>
            <p style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 15px;">Silakan pilih Admin yang tersedia untuk konfirmasi:</p>
            
            <div id="adminListContainer" class="admin-list">
                <div style="text-align: center; color: #64748b;">Memuat kontak...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let transaction = null;
        let adminContacts = []; 

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Ambil Data Transaksi
            const rawData = localStorage.getItem('currentTransaction');
            if (!rawData) {
                alert('Tidak ada data transaksi.');
                window.location.href = '/ppob.html';
                return;
            }
            transaction = JSON.parse(rawData);

            // 2. Render Data ke HTML
            document.getElementById('dispProduct').innerText = transaction.productName;
            document.getElementById('dispNumber').innerText = transaction.customerNumber;
            document.getElementById('dispCategory').innerText = transaction.productCategory.name || transaction.productCategory;
            document.getElementById('dispPrice').innerText = 'Rp ' + new Intl.NumberFormat('id-ID').format(transaction.productPrice);

            // 3. Ambil Data Admin dari Server
            try {
                const res = await fetch(`${API_URL}/settings`);
                const settings = await res.json();
                
                // Hanya ambil kontak tambahan yang aktif
                if (settings.adminContacts && settings.adminContacts.length > 0) {
                    adminContacts = settings.adminContacts.filter(a => a.isActive);
                }
                
                renderAdminList();

            } catch (error) {
                console.error('Gagal ambil info admin', error);
                document.getElementById('adminListContainer').innerHTML = '<div style="color:#ef4444; text-align:center;">Gagal memuat kontak admin.</div>';
            }
        });

        function renderAdminList() {
            const container = document.getElementById('adminListContainer');
            container.innerHTML = '';

            if (adminContacts.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#ef4444; padding:10px;">Belum ada kontak admin yang ditambahkan.</div>`;
                return;
            }

            adminContacts.forEach(admin => {
                const div = document.createElement('div');
                div.className = 'admin-item';
                div.onclick = () => sendToWhatsApp(admin.phone);
                div.innerHTML = `
                    <div class="admin-avatar"><i class="fa-brands fa-whatsapp"></i></div>
                    <div style="flex: 1;">
                        <div style="color: white; font-weight: 600;">${admin.name}</div>
                        <div style="color: #94a3b8; font-size: 0.8rem;">Online</div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: #4ade80;"></i>
                `;
                container.appendChild(div);
            });
        }

        function openAdminModal() {
            document.getElementById('adminModal').classList.add('show');
        }
        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
        }

        function sendToWhatsApp(phone) {
            if (!transaction) return;

            const message = `Halo Admin RinsPoint, saya mau order PPOB:%0A%0A` +
                            `ðŸ“¦ *Produk:* ${transaction.productName}%0A` +
                            `ðŸ“± *Nomor:* ${transaction.customerNumber}%0A` +
                            `ðŸ’° *Harga:* Rp ${new Intl.NumberFormat('id-ID').format(transaction.productPrice)}%0A%0A` +
                            `Mohon diproses, pembayaran via apa ya?`;

            const url = `https://wa.me/${phone}?text=${message}`;
            window.open(url, '_blank');
            closeAdminModal();
        }
    </script>

</body>
</html>