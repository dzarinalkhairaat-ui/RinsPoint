<!DOCTYPE html>
<html lang="id">
<head>

    <script>
    // CEK SESI LOGIN (VERSI POPUP ALERT)
    function checkLoginSession() {
        const user = JSON.parse(localStorage.getItem('rinsUser'));
        
        // 1. Cek apakah user ada?
        if (!user || !user.isLoggedIn) {
            window.location.replace('/login-pelanggan.html');
            return;
        }

        // 2. Cek Waktu (2 Menit = 120.000 ms)
        const currentTime = Date.now();
        const lastActive = user.lastActive || 0;
        const timeDiff = currentTime - lastActive;
        const maxIdleTime = 2 * 60 * 1000; // 2 Menit

        if (timeDiff > maxIdleTime) {
            // Tampilkan Popup Alert
            alert("Maaf, sesi Anda telah habis karena tidak aktif selama 2 menit. Silakan login kembali.");
            
            // Hapus data & Tendang ke Login
            localStorage.removeItem('rinsUser');
            window.location.replace('/login-pelanggan.html');
        } else {
            // Perbarui waktu aktif (agar tidak logout kalau user aktif)
            user.lastActive = currentTime;
            localStorage.setItem('rinsUser', JSON.stringify(user));
        }
    }
    // Jalankan Pengecekan
    checkLoginSession();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pembayaran - RinsPoint</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* TAMBAHAN CSS KHUSUS QRIS & LIST */
        .qris-box {
            background: white; padding: 1.5rem; border-radius: 16px;
            text-align: center; margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(255,255,255,0.1);
        }
        .qris-box img { width: 100%; max-width: 250px; height: auto; border: 2px solid #000; border-radius: 8px; }
        .qris-info { color: #333; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
        .qris-logos { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .qris-logos i { font-size: 1.5rem; color: #333; }

        /* Judul Section */
        .method-title {
            font-size: 0.9rem; color: #4ADE80; font-weight: 600;
            margin-bottom: 10px; margin-top: 1.5rem; letter-spacing: 1px;
            text-transform: uppercase; border-left: 3px solid #4ADE80; padding-left: 10px;
        }

        /* Item Bank/Wallet */
        .bank-item {
            background: #1E293B; border-radius: 12px; padding: 1rem;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 10px; border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .bank-info { display: flex; align-items: center; gap: 1rem; }
        .bank-icon { width: 50px; height: 30px; object-fit: contain; background: white; border-radius: 4px; padding: 2px; }
        .bank-text strong { display: block; color: white; font-size: 0.9rem; }
        .bank-text span { color: #94a3b8; font-size: 0.85rem; font-family: monospace; }
        
        .btn-copy { color: #4ADE80; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .btn-copy:active { transform: scale(0.8); }

        .loading-text { text-align: center; color: #94a3b8; margin-top: 2rem; }

        /* Style Khusus SN / Token */
        .sn-box {
            background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e;
            padding: 10px; border-radius: 8px; margin-top: 10px;
            display: none; /* Sembunyi default */
            flex-direction: column; gap: 5px;
        }
    </style>
</head>
<body>

    <div class="mobile-container">
        <header class="main-header">
            <a href="/" class="btn-back" style="color:white; margin-right:1rem;"><i class="fa-solid fa-house"></i></a>
            <div class="logo-text">Selesaikan Pembayaran</div>
        </header>

        <main class="payment-page">
            
            <div class="status-banner">
                <p>Selesaikan pembayaran dalam</p>
                <div class="timer" id="countdown">23:59:59</div>
            </div>

            <div class="invoice-card">
                <div class="amount-box">
                    <span>Total Pembayaran</span>
                    <h2 id="totalAmount">Rp 0 <i class="fa-regular fa-copy copy-icon" onclick="copyText('amountRaw')"></i></h2>
                    <span id="amountRaw" style="display:none;">0</span> 
                </div>
                
                <div class="detail-row">
                    <span class="label">ID Transaksi</span>
                    <span class="value" id="trxId">-</span>
                </div>
                <div class="detail-row">
                    <span class="label">Produk</span>
                    <span class="value" id="productName">-</span>
                </div>
                <div class="detail-row">
                    <span class="label">Nomor Tujuan</span>
                    <span class="value" id="customerPhone">-</span>
                </div>
                
                <div class="detail-row">
                    <span class="label">Status</span>
                    <span class="value" id="trxStatus" style="color:#F59E0B; font-weight:bold;">PENDING</span>
                </div>

                <div id="snRow" class="sn-box">
                    <span style="color:#4ADE80; font-size:0.8rem;">SN / KODE TOKEN:</span>
                    <span id="trxSN" style="color:white; font-family:monospace; font-size:1.1rem; font-weight:bold; word-break:break-all;">-</span>
                </div>
            </div>

            <div class="payment-methods">
                
                <div class="method-title">Scan QRIS (Otomatis & Cepat)</div>
                <div class="qris-box">
                    <img src="assets/images/qris.png" alt="Scan QRIS RinsPoint" onerror="this.src='https://via.placeholder.com/250x250?text=QRIS+CODE'">
                    <div class="qris-info">Scan menggunakan e-Wallet / M-Banking</div>
                    <div class="qris-logos">
                        <i class="fa-solid fa-wallet"></i>
                        <i class="fa-solid fa-building-columns"></i>
                    </div>
                </div>

                <div class="method-title">Transfer Bank</div>
                
                <div class="bank-item">
                    <div class="bank-info">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Bank_Central_Asia.svg" class="bank-icon" alt="BCA">
                        <div class="bank-text">
                            <strong>Bank BCA</strong>
                            <span id="rekBCA">1234567890</span>
                        </div>
                    </div>
                    <i class="fa-regular fa-copy btn-copy" onclick="copyText('rekBCA')"></i>
                </div>

                <div class="bank-item">
                    <div class="bank-info">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/BANK_BRI_logo.svg" class="bank-icon" alt="BRI">
                        <div class="bank-text">
                            <strong>Bank BRI</strong>
                            <span id="rekBRI">0000123456789</span>
                        </div>
                    </div>
                    <i class="fa-regular fa-copy btn-copy" onclick="copyText('rekBRI')"></i>
                </div>

                <div class="bank-item">
                    <div class="bank-info">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/Bank_Mandiri_logo_2016.svg" class="bank-icon" alt="Mandiri">
                        <div class="bank-text">
                            <strong>Bank Mandiri</strong>
                            <span id="rekMandiri">111222333444</span>
                        </div>
                    </div>
                    <i class="fa-regular fa-copy btn-copy" onclick="copyText('rekMandiri')"></i>
                </div>

                <div class="method-title">E-Wallet</div>

                <div class="bank-item">
                    <div class="bank-info">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/1200px-Logo_dana_blue.svg.png" class="bank-icon" alt="DANA">
                        <div class="bank-text">
                            <strong>DANA</strong>
                            <span id="rekDANA">081234567890</span>
                        </div>
                    </div>
                    <i class="fa-regular fa-copy btn-copy" onclick="copyText('rekDANA')"></i>
                </div>

                <div class="bank-item">
                    <div class="bank-info">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Shopee.svg" class="bank-icon" alt="Shopee">
                        <div class="bank-text">
                            <strong>ShopeePay</strong>
                            <span id="rekShopee">081234567890</span>
                        </div>
                    </div>
                    <i class="fa-regular fa-copy btn-copy" onclick="copyText('rekShopee')"></i>
                </div>

            </div>
            
            <a href="#" id="btnConfirmWA" class="btn-confirm-wa" target="_blank">
                <i class="fa-brands fa-whatsapp"></i> Konfirmasi ke Admin
            </a>

        </main>
    </div>

    <script>
        const API_URL = '/api';
        
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const trxId = urlParams.get('trxId');

            if (!trxId) {
                alert('ID Transaksi tidak ditemukan');
                window.location.href = '/';
                return;
            }

            try {
                // Ambil Detail dari Backend
                const res = await fetch(`${API_URL}/ppob/transaction/${trxId}`);
                const data = await res.json();

                if (!res.ok) throw new Error(data.message);

                // Isi Data Dasar
                document.getElementById('trxId').innerText = data.trxId;
                document.getElementById('productName').innerText = data.digiflazzResponse?.productName || data.productCode;
                document.getElementById('customerPhone').innerText = data.customerPhone;
                
                // Format Rupiah
                const total = data.amount;
                document.getElementById('totalAmount').innerHTML = `Rp ${new Intl.NumberFormat('id-ID').format(total)} <i class="fa-regular fa-copy copy-icon" onclick="copyText('amountRaw')"></i>`;
                document.getElementById('amountRaw').innerText = total;

                // --- LOGIKA STATUS & SN (WEBHOOK) ---
                const statusEl = document.getElementById('trxStatus');
                statusEl.innerText = data.status.toUpperCase();

                if (data.status === 'success') {
                    statusEl.style.color = '#4ADE80'; // Hijau
                    document.querySelector('.status-banner').style.display = 'none'; // Sembunyikan Timer
                    
                    // Tampilkan SN jika ada
                    if (data.sn) {
                        document.getElementById('snRow').style.display = 'flex';
                        document.getElementById('trxSN').innerText = data.sn;
                    }
                } else if (data.status === 'failed') {
                    statusEl.style.color = '#EF4444'; // Merah
                    statusEl.innerText = 'GAGAL / REFUND';
                }

                // Update Link WA
                const adminWA = "6281234567890"; // GANTI NOMOR ADMIN
                const msg = `Halo Admin RinsPoint,%0ASaya sudah transfer Rp ${new Intl.NumberFormat('id-ID').format(total)}.%0A%0A*Detail:*%0A- No Order: ${data.trxId}%0A- Status: ${data.status.toUpperCase()}%0A%0AMohon diproses.`;
                document.getElementById('btnConfirmWA').href = `https://wa.me/${adminWA}?text=${msg}`;

                // Jalankan timer hanya jika masih pending
                if(data.status === 'pending') startTimer(24 * 60 * 60);

            } catch (error) {
                alert('Gagal memuat transaksi: ' + error.message);
                window.location.href = '/';
            }
        });

        function copyText(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => alert('Disalin: ' + text));
        }

        function startTimer(duration) {
            let timer = duration, hours, minutes, seconds;
            const interval = setInterval(() => {
                hours = parseInt(timer / 3600, 10);
                minutes = parseInt((timer % 3600) / 60, 10);
                seconds = parseInt(timer % 60, 10);

                hours = hours < 10 ? "0" + hours : hours;
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                const display = document.getElementById('countdown');
                if(display) display.textContent = hours + ":" + minutes + ":" + seconds;

                if (--timer < 0) clearInterval(interval);
            }, 1000);
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // ===========================================
            // 1. CEK SESI LOGIN (FITUR AUTO LOGOUT 2 MENIT)
            // ===========================================
            function checkLoginSession() {
                const user = JSON.parse(localStorage.getItem('rinsUser'));
                
                // A. Cek apakah user sudah login?
                if (!user || !user.isLoggedIn) {
                    window.location.href = '/login-pelanggan.html';
                    return;
                }

                // B. Cek Waktu (2 Menit = 120.000 ms)
                const currentTime = Date.now();
                const lastActive = user.lastActive || 0;
                const timeDiff = currentTime - lastActive;
                const maxIdleTime = 2 * 60 * 1000; // 2 Menit

                if (timeDiff > maxIdleTime) {
                    // WAKTU HABIS: Hapus sesi & Tendang ke login
                    alert("Sesi berakhir (2 Menit Inaktif). Silakan login kembali.");
                    localStorage.removeItem('rinsUser');
                    window.location.href = '/login-pelanggan.html';
                } else {
                    // MASIH AKTIF: Perbarui waktu (Reset timer)
                    user.lastActive = currentTime;
                    localStorage.setItem('rinsUser', JSON.stringify(user));
                }
            }
            // Jalankan pengecekan saat halaman dibuka
            checkLoginSession();


            // ===========================================
            // 2. LOGIKA PENCARIAN (SEARCH)
            // ===========================================
            const homeInput = document.getElementById('homeSearchInput');
            const homeIcon = document.getElementById('homeSearchIcon');

            const goToSearchPage = () => {
                const keyword = homeInput.value.trim();
                if (keyword) {
                    window.location.href = `search.html?keyword=${encodeURIComponent(keyword)}`;
                } else {
                    homeInput.focus();
                }
            };

            if (homeInput) {
                homeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') goToSearchPage();
                });
            }

            if (homeIcon) {
                homeIcon.addEventListener('click', goToSearchPage);
            }


            // ===========================================
            // 3. LOGIKA BADGE TROLI (ANGKA MERAH)
            // ===========================================
            const cart = JSON.parse(localStorage.getItem('rinsCart')) || [];
            const badge = document.getElementById('cartBadge');
            
            if (badge) {
                badge.innerText = cart.length;
                if (cart.length > 0) {
                    badge.classList.add('show');
                } else {
                    badge.classList.remove('show');
                }
            }
        });
    </script>

</body>
</html>