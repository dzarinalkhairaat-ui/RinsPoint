<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Play Gift Card</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET & BACKGROUND --- */
        html { height: 100%; background: #202124; }
        body { 
            margin: 0; min-height: 100%; color: #e8eaed; font-family: 'Poppins', sans-serif;
            overflow-x: hidden; position: relative;
            background-color: #202124;
        }

        /* Animasi Background Prism */
        .prism-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            overflow: hidden;
            background: radial-gradient(circle at center, #303134 0%, #202124 100%);
        }
        .triangle {
            position: absolute; width: 0; height: 0;
            border-left: 100px solid transparent;
            border-right: 100px solid transparent;
            border-bottom: 170px solid rgba(255, 255, 255, 0.03);
            filter: blur(30px); animation: floatTri 12s infinite linear;
        }
        /* Warna-warni Google */
        .t1 { top: 10%; left: 10%; border-bottom-color: rgba(66, 133, 244, 0.2); animation-duration: 15s; } /* Blue */
        .t2 { bottom: 20%; right: 10%; border-bottom-color: rgba(234, 67, 53, 0.2); animation-duration: 18s; transform: rotate(45deg); } /* Red */
        .t3 { top: 40%; right: 30%; border-bottom-color: rgba(251, 188, 5, 0.2); animation-duration: 20s; transform: rotate(180deg); } /* Yellow */
        .t4 { bottom: 10%; left: 20%; border-bottom-color: rgba(52, 168, 83, 0.2); animation-duration: 12s; transform: rotate(-45deg); } /* Green */

        @keyframes floatTri {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            50% { transform: translateY(-40px) rotate(10deg) scale(1.1); }
            100% { transform: translateY(0) rotate(0deg) scale(1); }
        }

        .mobile-container {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            display: flex; flex-direction: column; position: relative;
            background: rgba(32, 33, 36, 0.6); 
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        /* --- HEADER --- */
        .play-header {
            padding: 20px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 50;
            background: rgba(32, 33, 36, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .btn-back { color: #e8eaed; font-size: 1.2rem; text-decoration: none; }
        .page-title { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; }
        .page-title span { color: #4285F4; } /* Blue Accent */

        /* --- HERO: GIFT CARD --- */
        .hero-area { padding: 30px 20px; }
        .gift-card {
            background: #fff;
            border-radius: 16px; padding: 5px; /* Border like wrapper */
            background: linear-gradient(45deg, #4285F4, #EA4335, #FBBC05, #34A853);
            box-shadow: 0 10px 30px -5px rgba(66, 133, 244, 0.3);
            position: relative;
        }
        .inner-card {
            background: #202124; border-radius: 14px; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 120px; position: relative; overflow: hidden;
        }
        /* Pattern segitiga di dalam kartu */
        .inner-card::after {
            content: '\f04b'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; right: -20px; bottom: -20px;
            font-size: 8rem; color: rgba(255,255,255,0.03); transform: rotate(-15deg);
        }

        .card-text h3 { margin: 0; font-size: 1.2rem; color: #fff; font-weight: 700; text-transform: uppercase; }
        .card-text p { margin: 5px 0 0 0; font-size: 0.75rem; color: #9aa0a6; }
        .play-logo { font-size: 2.5rem; background: linear-gradient(45deg, #4285F4, #EA4335, #FBBC05, #34A853); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- INPUT --- */
        .form-area { padding: 0 20px 20px 20px; }
        .input-label { color: #4285F4; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .input-wrap {
            background: #303134; border: 1px solid #5f6368;
            border-radius: 8px; padding: 12px 15px;
            display: flex; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .input-wrap:focus-within {
            border-color: #4285F4; box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        .play-input {
            width: 100%; background: transparent; border: none; outline: none;
            color: #fff; font-size: 1.1rem; font-weight: 500;
        }
        .info-text { font-size: 0.7rem; color: #9aa0a6; margin-top: 8px; font-style: italic; }

        /* --- GRID NOMINAL --- */
        .grid-area { padding: 10px 20px 120px 20px; }
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .grid-item {
            background: #303134; border: 1px solid transparent;
            border-radius: 12px; padding: 15px;
            cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
        }
        .grid-item:hover { background: #3c4043; }
        
        .grid-item.selected {
            background: #3c4043; border-color: #34A853; /* Green border on select */
            box-shadow: 0 4px 15px rgba(52, 168, 83, 0.2);
        }
        /* Triangle Corner Badge */
        .grid-item.selected::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-style: solid; border-width: 0 40px 40px 0;
            border-color: transparent #34A853 transparent transparent;
        }
        .grid-item.selected::before {
            content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: 5px; right: 5px; color: #fff; font-size: 0.7rem; z-index: 2;
        }

        .code-val { font-size: 1.1rem; font-weight: 700; color: #fff; display: block; }
        .code-price { font-size: 0.85rem; color: #4285F4; margin-top: 5px; display: block; }
        .grid-item.selected .code-price { color: #34A853; }

        /* --- BUTTON BAYAR --- */
        .btn-container { margin-top: 30px; width: 100%; }
        .btn-pay {
            width: 100%; padding: 16px; border: none; border-radius: 8px;
            background: linear-gradient(90deg, #4285F4, #34A853);
            color: #fff; font-size: 1rem; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-pay:active { transform: scale(0.98); }
        .btn-pay:disabled {
            background: #3c4043; color: #5f6368; box-shadow: none; cursor: not-allowed; opacity: 0.7;
        }

        /* Banner Toko Tutup */
        .store-closed-banner {
            background: rgba(234, 67, 53, 0.15); border: 1px dashed #EA4335; color: #EA4335;
            padding: 20px; border-radius: 12px; text-align: center; font-weight: 600;
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .store-closed-banner i { font-size: 2rem; margin-bottom: 10px; display: block; }

    </style>
</head>
<body>

    <div class="prism-bg">
        <div class="triangle t1"></div>
        <div class="triangle t2"></div>
        <div class="triangle t3"></div>
        <div class="triangle t4"></div>
    </div>

    <div class="mobile-container">
        
        <header class="play-header">
            <a href="../ppob.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
            <div class="page-title">Google <span>Play</span></div>
            <i class="fa-brands fa-google-play" style="color: #e8eaed;"></i>
        </header>

        <div class="hero-area">
            <div class="gift-card">
                <div class="inner-card">
                    <div class="card-text">
                        <h3>Gift Card</h3>
                        <p>Kode Voucher GooglePlay</p>
                    </div>
                    <i class="fa-brands fa-google-play play-logo"></i>
                </div>
            </div>
        </div>

        <div class="form-area">
            <div id="closedBannerContainer"></div> <div class="input-label"><i class="fa-solid fa-mobile-screen"></i> Nomor Penerima Kode</div>
            <div class="input-wrap">
                <input type="tel" class="play-input" placeholder="08xxxxxxxxxx" id="phoneNumber" oninput="validateInput()">
                <i class="fa-solid fa-address-book" style="color: #5f6368; cursor: pointer;"></i>
            </div>
            <div class="info-text">Kode voucher akan dikirim melalui SMS/WhatsApp ke nomor ini.</div>
        </div>

        <div class="grid-area">
            <div class="input-label" style="margin-bottom: 15px; color:#e8eaed;">Pilih Nominal Voucher</div>
            <div class="grid-box" id="nominalContainer">
                <div style="grid-column: span 2; text-align: center; color: #9aa0a6;">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Memuat...
                </div>
            </div>

            <div class="btn-container">
                <button class="btn-pay" id="btnPay" disabled onclick="goToPayment()">
                    Lanjut ke Pembayaran <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <a href="/"><i class="fa-solid fa-house"></i><span>Beranda</span></a>
        <a href="/ppob.html" class="active"><i class="fa-solid fa-bolt"></i><span>PPOB</span></a>
        <a href="/cart.html"><i class="fa-solid fa-cart-shopping"></i><span>Troli</span></a>
        <a href="/admin/dashboard.html"><i class="fa-solid fa-user-shield"></i><span>Admin</span></a>
    </nav>

    <script>
        const API_URL = '/api';
        const TARGET_CATEGORY = 'GooglePlay'; // Pastikan di Admin kategori produknya "GooglePlay"
        let selectedProduct = null;
        let globalMargin = 0;
        let isStoreOpen = true;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
        });

        // 1. Fetch Data dari Database Admin (Dengan Margin)
        async function loadData() {
            const container = document.getElementById('nominalContainer');
            const bannerContainer = document.getElementById('closedBannerContainer');
            const btnPay = document.getElementById('btnPay');

            try {
                // A. Cek Status Toko & Margin
                const config = JSON.parse(localStorage.getItem('ppobConfig')) || { isOpen: true, margin: 0 };
                globalMargin = parseInt(config.margin) || 0;
                isStoreOpen = config.isOpen;

                // B. Jika Toko Tutup, Blokir Tampilan
                if (!isStoreOpen) {
                    bannerContainer.innerHTML = `
                        <div class="store-closed-banner">
                            <i class="fa-solid fa-shop-lock"></i>
                            MAAF, TOKO SEDANG TUTUP
                        </div>
                    `;
                    document.getElementById('phoneNumber').disabled = true;
                    btnPay.disabled = true;
                    btnPay.innerText = "Toko Tutup";
                    btnPay.style.background = "#3c4043";
                    btnPay.style.cursor = "not-allowed";
                    btnPay.style.opacity = "0.7";
                    
                    container.innerHTML = ''; 
                    return; 
                }

                // C. Load Produk
                const res = await fetch(`${API_URL}/products?platform=PPOB&category=${encodeURIComponent(TARGET_CATEGORY)}&sort=lowest`);
                const products = await res.json();

                container.innerHTML = ''; // Hapus loading

                if (products.length === 0) {
                    container.innerHTML = `<div style="grid-column:span 2; text-align:center; color:#ef4444; padding:20px;">Voucher Kosong</div>`;
                    return;
                }

                // D. Render Produk dengan Harga + Margin
                products.forEach(p => {
                    const finalPrice = p.price + globalMargin;
                    const priceFormatted = new Intl.NumberFormat('id-ID').format(finalPrice);
                    
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    div.onclick = () => selectCard(div, p, finalPrice);
                    
                    // TAMPILKAN NAMA PRODUK APA ADANYA
                    div.innerHTML = `
                        <span class="code-val">${p.name}</span>
                        <span class="code-price">Rp ${priceFormatted}</span>
                    `;
                    container.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                container.innerHTML = `<div style="grid-column:span 2; text-align:center; color:#ef4444;">Gagal memuat data.</div>`;
            }
        }

        // 2. Logic Pilih Produk
        function selectCard(el, productData, priceWithMargin) {
            if(!isStoreOpen) return;

            document.querySelectorAll('.grid-item').forEach(item => item.classList.remove('selected'));
            el.classList.add('selected');
            
            selectedProduct = { ...productData, finalPrice: priceWithMargin }; 
            validateInput();
        }

        function validateInput() {
            const phone = document.getElementById('phoneNumber').value;
            const btn = document.getElementById('btnPay');

            if(!isStoreOpen) return;

            if (phone.length > 9 && selectedProduct !== null) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        // 3. Proses ke Halaman Payment
        function goToPayment() {
            if (!selectedProduct) return;
            const phone = document.getElementById('phoneNumber').value;

            // Simpan data transaksi ke LocalStorage
            const transactionData = {
                productId: selectedProduct._id,
                productName: selectedProduct.name,
                productPrice: selectedProduct.finalPrice, // Pakai harga margin
                customerNumber: phone,
                category: TARGET_CATEGORY
            };

            localStorage.setItem('currentTransaction', JSON.stringify(transactionData));
            
            // Redirect ke halaman checkout
            window.location.href = '../payment.html';
        }
    </script>
</body>
</html>