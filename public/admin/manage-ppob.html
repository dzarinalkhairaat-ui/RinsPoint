<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kelola PPOB - Admin</title>
    
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="../js/auth.js"></script>
    <script>checkAuth();</script>

    <style>
        body { background-color: #0f172a; padding-bottom: 80px; }
        .dashboard-header { background: #1e293b; padding: 1rem; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: flex-start; gap: 15px; }
        .dashboard-header h2 { margin: 0; color: #4ade80; font-size: 1.1rem; }
        .tools-box { margin: 15px; display: flex; flex-direction: column; gap: 10px; }
        .search-row { display: flex; gap: 10px; }
        .search-input { flex: 1; background: #1e293b; border: 1px solid #334155; padding: 12px; border-radius: 10px; color: white; outline: none; }
        .filter-select { background: #1e293b; border: 1px solid #334155; padding: 12px; border-radius: 10px; color: #94a3b8; outline: none; flex: 1; cursor: pointer; }
        .btn-add { background: #4ade80; color: #064e3b; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .ppob-list { padding: 0 15px; display: grid; gap: 10px; }
        .ppob-item { background: #1e293b; padding: 12px; border-radius: 12px; border: 1px solid #334155; display: flex; align-items: center; gap: 12px; }
        .item-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #0f172a; border: 1px solid #334155; }
        .item-thumb-placeholder { width: 50px; height: 50px; border-radius: 8px; background: rgba(74, 222, 128, 0.1); display: flex; align-items: center; justify-content: center; color: #4ade80; font-size: 1.2rem; border: 1px solid rgba(74, 222, 128, 0.2); }
        .item-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .item-category { font-size: 0.65rem; background: rgba(255, 255, 255, 0.1); color: #cbd5e1; padding: 2px 6px; border-radius: 4px; width: fit-content; }
        .item-name { color: white; font-weight: 600; font-size: 0.95rem; }
        .item-price { color: #f59e0b; font-weight: bold; font-size: 0.9rem; }
        .item-actions { display: flex; gap: 8px; }
        .btn-icon { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px; }
        .btn-edit { color: #3b82f6; }
        .btn-delete { color: #ef4444; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #1e293b; width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; border: 1px solid #334155; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #94a3b8; margin-bottom: 5px; font-size: 0.85rem; }
        .form-input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; outline: none; }
        .form-select { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; outline: none; cursor: pointer; }
        .img-preview-box { width: 100%; height: 150px; background: #0f172a; border: 2px dashed #334155; border-radius: 10px; margin-top: 10px; overflow: hidden; display: none; align-items: center; justify-content: center; }
        .img-preview-box.active { display: flex; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: contain; }
        .modal-footer { display: flex; gap: 10px; margin-top: 20px; }
        .btn-submit { flex: 1; background: #4ade80; color: #064e3b; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { flex: 1; background: #334155; color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer; }
        .margin-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #60a5fa; font-size: 0.75rem; padding: 8px; border-radius: 8px; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="mobile-container">
        <header class="dashboard-header">
            <a href="dashboard.html" style="color:white; font-size: 1.2rem;"><i class="fa-solid fa-arrow-left"></i></a>
            <h2>Kelola PPOB</h2>
        </header>

        <div class="tools-box">
            <div class="search-row">
                <input type="text" id="searchInput" class="search-input" placeholder="Cari produk..." onkeyup="filterProducts()">
                <button class="btn-add" onclick="openModal('add')"><i class="fa-solid fa-plus"></i></button>
            </div>
            <select id="filterCategory" class="filter-select" onchange="filterProducts()">
                <option value="">Semua Kategori</option>
                <option value="Pulsa">Pulsa</option>
                <option value="Data">Data</option>
                <option value="PLN">PLN</option>
                <option value="E-Wallet">E-Wallet</option>
                <option value="Game">Game</option>
            </select>
        </div>

        <div id="ppobListContainer" class="ppob-list">
            <p style="text-align:center; color:#64748b; margin-top:20px;">Memuat data...</p>
        </div>

        <nav class="bottom-nav">
            <a href="/"><i class="fa-solid fa-store"></i><span>Toko</span></a>
            <a href="dashboard.html" class="active"><i class="fa-solid fa-chart-line"></i><span>Dashboard</span></a>
            <a href="ppob-settings.html"><i class="fa-solid fa-sliders"></i><span>PPOB</span></a>
            <a href="#" onclick="logout()"><i class="fa-solid fa-power-off"></i><span>LogOut</span></a>
        </nav>
    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle" style="color:white; margin-bottom:20px;">Tambah Produk</h3>
            <form id="ppobForm">
                <input type="hidden" id="productId"> 
                <div class="form-group"><label>Nama Produk</label><input type="text" id="pName" class="form-input" placeholder="Contoh: Pulsa 10.000" required></div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="pCategory" class="form-select" required>
                        <option value="" disabled selected>Pilih Kategori</option>
                        <optgroup label="ISI ULANG" style="color: #4ade80;">
                            <option value="Pulsa">Pulsa Reguler</option>
                            <option value="Data">Paket Data</option>
                            <option value="PLN">Token Listrik (PLN)</option>
                        </optgroup>
                        <optgroup label="E-WALLET" style="color: #60a5fa;">
                            <option value="Dana">Dana</option>
                            <option value="Ovo">Ovo</option>
                            <option value="Gopay">Gopay</option>
                            <option value="ShopeePay">ShopeePay</option>
                        </optgroup>
                        <optgroup label="GAME" style="color: #f59e0b;">
                            <option value="Mobile Legend">Mobile Legend</option>
                            <option value="PUBG">PUBG Mobile</option>
                            <option value="Free Fire">Free Fire</option>
                            <option value="Roblox">Roblox</option>
                            <option value="GooglePlay">Google Play</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Harga Modal (Rp)</label>
                    <input type="number" id="pBasePrice" class="form-input" placeholder="Contoh: 10500" required>
                    <div class="margin-info">
                        <i class="fa-solid fa-circle-info"></i> Margin Aktif: <b>Rp <span id="displayMargin">0</span></b><br>
                        Harga Jual nanti: <b>Rp <span id="displayFinalPrice">0</span></b>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gambar (Opsional)</label>
                    <input type="file" id="pImage" class="form-input" accept="image/*" onchange="previewImage(this)">
                    <div id="imagePreviewBox" class="img-preview-box"><img id="imgPreview" src="" alt="Preview"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Batal</button>
                    <button type="submit" class="btn-submit" id="btnSave">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('adminToken');
        let allProducts = [];
        let globalMargin = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            await loadGlobalSettings(); 
            await loadPPOBProducts();   
        });

        async function loadGlobalSettings() {
            try {
                const res = await fetch(`${API_URL}/settings`);
                const data = await res.json();
                globalMargin = data.ppobMargin || 0;
                document.getElementById('displayMargin').innerText = new Intl.NumberFormat('id-ID').format(globalMargin);
            } catch (error) { console.error(error); }
        }

        async function loadPPOBProducts() {
            const container = document.getElementById('ppobListContainer');
            try {
                const res = await fetch(`${API_URL}/products?platform=PPOB`);
                const data = await res.json();
                allProducts = data;
                filterProducts();
            } catch (error) { console.error(error); container.innerHTML = '<p style="text-align:center; color:#ef4444;">Gagal memuat data.</p>'; }
        }

        function renderList(products) {
            const container = document.getElementById('ppobListContainer');
            container.innerHTML = '';
            if (products.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#64748b; padding:40px;"><i class="fa-solid fa-box-open" style="font-size:3rem; margin-bottom:10px;"></i><br>Data kosong.<br>Klik tombol + untuk menambah.</div>`;
                return;
            }
            products.forEach(p => {
                const catName = p.category ? (p.category.name || p.category) : '-';
                // Tampilkan Harga Modal di Admin (Data Asli)
                const hargaModal = new Intl.NumberFormat('id-ID').format(p.price); 
                
                let thumbHTML = '';
                if (p.images && p.images.length > 0) {
                    thumbHTML = `<img src="${p.images[0]}" class="item-thumb" alt="img">`;
                } else {
                    thumbHTML = `<div class="item-thumb-placeholder"><i class="fa-solid fa-cube"></i></div>`;
                }

                const div = document.createElement('div');
                div.className = 'ppob-item';
                div.innerHTML = `
                    ${thumbHTML}
                    <div class="item-info">
                        <span class="item-category">${catName}</span>
                        <div class="item-name">${p.name}</div>
                        <div class="item-price">Rp ${hargaModal} (Modal)</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon btn-edit" onclick='editProduct(${JSON.stringify(p)})'><i class="fa-solid fa-pen-to-square"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteProduct('${p._id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function previewImage(input) {
            const box = document.getElementById('imagePreviewBox');
            const img = document.getElementById('imgPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    box.classList.add('active');
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                box.classList.remove('active');
            }
        }

        document.getElementById('ppobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.innerText = 'Menyimpan...';
            btn.disabled = true;

            const id = document.getElementById('productId').value;
            const name = document.getElementById('pName').value;
            const category = document.getElementById('pCategory').value;
            
            // PENTING: Simpan Harga Modal (Tanpa Margin)
            const basePrice = parseInt(document.getElementById('pBasePrice').value) || 0;

            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('price', basePrice); // Simpan Modal ke DB
            formData.append('description', 'Produk PPOB Manual'); 
            formData.append('platform', 'PPOB'); 
            
            const imageFile = document.getElementById('pImage').files[0];
            if(imageFile) formData.append('image', imageFile);

            try {
                let url = `${API_URL}/products`;
                let method = 'POST';
                if (id) { url += `/${id}`; method = 'PUT'; }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (res.ok) {
                    closeModal();
                    loadPPOBProducts();
                    alert('Produk berhasil disimpan!');
                } else {
                    const err = await res.json();
                    alert('Gagal: ' + (err.message || 'Error server'));
                }
            } catch (error) { console.error(error); alert('Terjadi kesalahan.'); } 
            finally { btn.innerText = 'Simpan'; btn.disabled = false; }
        });

        async function deleteProduct(id) {
            if(!confirm('Yakin ingin menghapus produk ini?')) return;
            try {
                const res = await fetch(`${API_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if(res.ok) loadPPOBProducts();
            } catch (error) { alert('Error server.'); }
        }

        function openModal(mode) {
            document.getElementById('productModal').classList.add('show');
            document.getElementById('imagePreviewBox').classList.remove('active');
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = 'Tambah Produk PPOB';
                document.getElementById('ppobForm').reset();
                document.getElementById('productId').value = '';
                document.getElementById('displayMargin').innerText = new Intl.NumberFormat('id-ID').format(globalMargin);
                document.getElementById('displayFinalPrice').innerText = '0';
            }
        }

        function editProduct(p) {
            openModal('edit');
            document.getElementById('modalTitle').innerText = 'Edit Produk';
            document.getElementById('productId').value = p._id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBasePrice').value = p.price; // Harga Modal dari DB
            document.getElementById('pBasePrice').dispatchEvent(new Event('input'));
            const catName = p.category ? (p.category.name || p.category) : '';
            document.getElementById('pCategory').value = catName;
            if(p.images && p.images.length > 0) {
                document.getElementById('imgPreview').src = p.images[0];
                document.getElementById('imagePreviewBox').classList.add('active');
            }
        }

        function closeModal() { document.getElementById('productModal').classList.remove('show'); }

        function filterProducts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const categoryQuery = document.getElementById('filterCategory').value;
            const filtered = allProducts.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(searchQuery);
                const catName = p.category ? (p.category.name || p.category) : '';
                let catMatch = true;
                if(categoryQuery) {
                    if(categoryQuery === 'E-Wallet') { catMatch = ['Dana','Ovo','Gopay','ShopeePay'].includes(catName); } 
                    else if(categoryQuery === 'Game') { catMatch = ['Mobile Legend','PUBG','Free Fire','Roblox','GooglePlay'].includes(catName); } 
                    else { catMatch = catName === categoryQuery; }
                }
                return nameMatch && catMatch;
            });
            renderList(filtered);
        }

        document.getElementById('pBasePrice').addEventListener('input', function() {
            const modal = parseInt(this.value) || 0;
            const final = modal + parseInt(globalMargin);
            document.getElementById('displayFinalPrice').innerText = new Intl.NumberFormat('id-ID').format(final);
        });

        function logout() {
            if(confirm('Keluar dari Admin?')) {
                localStorage.removeItem('adminToken');
                window.location.href = '/login.html';
            }
        }
    </script>
</body>
</html>