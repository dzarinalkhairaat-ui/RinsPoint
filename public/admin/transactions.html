<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Transaksi - Admin</title>
    <link rel="stylesheet" href="../css/style.css">

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0F172A">
    <link rel="apple-touch-icon" href="/assets/images/icon.png">
    
    <script src="/js/pwa-register.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="../js/auth.js"></script>
    <script>checkAuth();</script>

    <style>
        .admin-table-container {
            background: #1E293B; border-radius: 12px; overflow-x: auto; border: 1px solid #334155;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #334155; color: #cbd5e1; font-size: 0.9rem; }
        th { background: #0F172A; color: #4ADE80; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-pending { background: #F59E0B; color: #000; }
        .status-success { background: #22C55E; color: #fff; }
        .status-failed { background: #EF4444; color: #fff; }

        .page-header { display: flex; align-items: center; margin-bottom: 1.5rem; gap: 1rem; }
        .btn-back { color: #fff; font-size: 1.2rem; }

        /* Tombol Aksi Kecil */
        .btn-action {
            padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; margin-right: 5px;
        }
        .btn-acc { background: #22C55E; color: white; }
        .btn-reject { background: #EF4444; color: white; }
    </style>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0F172A">
    <link rel="apple-touch-icon" href="/assets/images/icon.png">
    
    <script src="/js/pwa-register.js"></script>
</head>
<body>

    <div class="mobile-container">
        <header class="main-header">
            <a href="dashboard.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
            <div class="logo-text">Riwayat Transaksi</div>
        </header>

        <main class="home-page" style="padding-top: 1rem;">
            <div class="admin-table-container">
                <table id="trxTable">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Detail Produk</th>
                            <th>Harga</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="5" style="text-align:center;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('adminToken');

        document.addEventListener('DOMContentLoaded', loadTransactions);

        async function loadTransactions() {
            try {
                const res = await fetch(`${API_URL}/ppob/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('tableBody');

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Belum ada transaksi.</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; 

                data.forEach(trx => {
                    const date = new Date(trx.createdAt).toLocaleDateString('id-ID', {
                        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                    });
                    const harga = new Intl.NumberFormat('id-ID').format(trx.amount);
                    const statusClass = `status-${trx.status}`;

                    // Tombol Aksi hanya muncul jika status masih 'pending'
                    let actionButtons = '-';
                    if (trx.status === 'pending') {
                        actionButtons = `
                            <button class="btn-action btn-acc" onclick="updateStatus('${trx._id}', 'success')">✔</button>
                            <button class="btn-action btn-reject" onclick="updateStatus('${trx._id}', 'failed')">✖</button>
                        `;
                    }

                    const row = `
                        <tr>
                            <td>${date}</td>
                            <td>
                                <strong style="color:white;">${trx.productCode}</strong><br>
                                <span style="font-size:0.75rem; color:#94a3b8;">${trx.customerPhone}</span>
                            </td>
                            <td style="color:#4ADE80;">Rp ${harga}</td>
                            <td><span class="status-badge ${statusClass}">${trx.status}</span></td>
                            <td>
                                <div style="display:flex; gap:5px;">
                                    ${actionButtons}
                                    <button class="btn-action btn-reject" onclick="deleteTrx('${trx._id}')" title="Hapus Riwayat">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error(error);
                alert('Gagal memuat data.');
            }
        }

        async function updateStatus(id, newStatus) {
            if(!confirm(`Ubah status menjadi ${newStatus}?`)) return;

            try {
                const res = await fetch(`${API_URL}/ppob/transaction/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    loadTransactions(); // Reload tabel
                } else {
                    alert('Gagal update status');
                }
            } catch (error) {
                alert('Error koneksi');
            }
        }

        // Fungsi Hapus Transaksi
        async function deleteTrx(id) {
            if(!confirm('Yakin ingin menghapus riwayat transaksi ini secara permanen?')) return;

            try {
                const res = await fetch(`${API_URL}/ppob/transaction/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadTransactions(); // Reload tabel
                    alert('Transaksi dihapus.');
                } else {
                    alert('Gagal menghapus.');
                }
            } catch (error) {
                alert('Error koneksi.');
            }
        }
    </script>
</body>
</html>